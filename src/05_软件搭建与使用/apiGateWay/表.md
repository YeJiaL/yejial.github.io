

1. 查询resultapi_modulartemp表 modular_status="true"

2. 根据查询结构获取到的modular_name 查询

   resultapi_confmapping中mapping_modular=modular_name的记录
   记录resultapi_confmapping 获取配置文件名字mapping_filename
   resultapi_configuration：根据配置文件名字查询端口

3. OtherConfiguration：判断当前是http还是https模式 ，部署类型
   











```
select
	*
from
	`token_sync`
where
	`token_sync`.`id` = 80210
	or cast(`token_sync`.`key` as CHAR character set utf8) collate utf8_general_ci like '%80210%'
	or cast(`token_sync`.`value` as CHAR character set utf8) collate utf8_general_ci like '%80210%'
	or cast(`token_sync`.`type` as CHAR character set utf8) collate utf8_general_ci like '%80210%'
	or cast(`token_sync`.`op_time` as CHAR character set utf8) collate utf8_general_ci like '%80210%';
```

查询四张表后根据id过滤

```
table_name_list = ['token_sync', 'token_auth', 'session_auth', 'session_intercept']
```

```
filter_list = ["38833fad-da2d-43ae-b3b9-1688eefb3dab", "2d06f96c-0322-41e4-ae42-2db88548a54b",
               "27bf65cd-b125-479c-ab26-fe3d741a4f66", "c5725764-7e58-4fc1-9ca6-a4224cb8f11d",
               "a08e8c46-487c-4e65-987a-69ec52f105f7", "fba465e8-97a5-4766-865a-5312b1292ec5",
               "dfee8e24-76e8-4b41-9088-0e37e8cdbc30", "2372f157-0556-4db7-8cdb-a938e378f9ed"]
```





token_sync

请求添加token，

添加调用院内接口CA token

```json
{
	"ca_url": "http://10.5.67.12:8083/ca/thirdparty/token",
	"interval": 60,
	"id": "cf5fed4d-9e22-40fb-8d17-27b78695ce4c",
	"name": "添加调用院内接口CA token",
	"secret": "bb1",
	"rules": [
		"d9beef23-4d5f-4dcb-a4eb-5ac5659d0db2",
		"50104c64-c954-41dc-bde5-f5bce870a237",
		"b5dbd9ee-0e8e-4f89-8d56-9d12b1864c79",
		"1220f354-19af-4570-aef7-ab45ff2dc2f9",
		"ee0713df-a87f-44df-8cd1-d1de37c067cd",
		"72d28922-99b7-4b26-ac41-43082cddd17a",
		"b05f4618-b2d8-4e4b-ac6c-3cdad4c87bdc",
		"3668b93d-92e6-4384-b096-626c584cd746",
		"3ff0dd96-7c7b-41db-ace4-10fbf4c542af",
		"5a92acdb-31c8-484f-aabf-d27b4433c4d2",
		"06744e70-e8a1-450b-bb9d-f9a62c06af4b",
		"0ad039c9-ba7e-424b-8c06-34b77238342d",
		"9411bddf-17dc-4373-a78b-4f639638660a",
		"5600a3b2-07f4-47a6-804b-255a6ce0ce0f",
		"c40531c2-fa25-47e8-8ca2-2ddde4b6615a",
		"e75fe130-e4d0-476c-adbe-396b52d9a2b9",
		"75463cc6-48b6-4c39-9f82-00bdd1556fe6",
		"378f24ba-43a0-45b7-88e9-030ce3d75c6c",
		"9cefe709-2bcc-4104-8b1c-71eb28cea2ac",
		"b21cc0e5-cace-4da5-8265-0ddf704a6877"
	],
	"time": "2023-03-10 14:53:36",
	"enable": true,
	"is_https": false,
	"judge": {
		"conditions": [
			{
				"value": "10.5.67.12",
				"operator": "=",
				"type": "Host"
			}
		],
		"type": 0
	},
	"appid": "aa1",
	"handle": {
		"continue": true,
		"log": false
	},
	"type": 1
}
```





appoint



```json
{
	"extractor": {
		"extractions": [],
		"type": 1
	},
	"enable": true,
	"id": "b21cc0e5-cace-4da5-8265-0ddf704a6877",
	"judge": {
		"conditions": [
			{
				"value": "10.5.67.12:8921",
				"operator": "=",
				"type": "HostPort"
			}
		],
		"type": 0
	},
	"name": "appoint",
	"handle": {
		"log": true
	},
	"time": "2022-05-23 16:08:16"
}
```



```
`key` IN ("38833fad-da2d-43ae-b3b9-1688eefb3dab", "2d06f96c-0322-41e4-ae42-2db88548a54b",
                       "27bf65cd-b125-479c-ab26-fe3d741a4f66", "c5725764-7e58-4fc1-9ca6-a4224cb8f11d",
                       "a08e8c46-487c-4e65-987a-69ec52f105f7", "fba465e8-97a5-4766-865a-5312b1292ec5",
                       "dfee8e24-76e8-4b41-9088-0e37e8cdbc30", "2372f157-0556-4db7-8cdb-a938e378f9ed")
```





预约现状

**请求添加token** 

添加调用院内接口CA token_二级站点----预约同步接口

添加调用院内接口CA toke---appoint

**token认证**   





基础数据



基础数据保存

datamaintenanceSave

1. 更新DataMaintenance表
2. 9999同步对外端口port syncExternalPortData （其中）

```

	
	
```





token_sync

一级

```
{
	"ca_url": "https://www.baidu.com:8083/ca/thirdparty/token",
	"interval": 60,
	"id": "6f88dce8-10dc-4662-aec2-3325d9dcd7e0",
	"name": "超声上级访问下级专用",
	"secret": "",
	"rules": [
		"a1e39abb-face-4a99-aec7-6b8a076c57ac",
		"1641f8de-93e9-44f9-88c0-bebd93e0e65d"
	],
	"time": "2020-08-11 10:37:25",
	"enable": false,
	"is_https": false,
	"judge": {
		"conditions": [
			{
				"value": "www.baidu.com",
				"operator": "=",
				"type": "Host"
			}
		],
		"type": 0
	},
	"appid": "",
	"handle": {
		"continue": true,
		"log": false
	},
	"type": 1
}
```

二级

```json
{
	"extractor": {
		"extractions": [],
		"type": 1
	},
	"enable": false,
	"id": "bc859649-d02d-47ea-9cd4-4daad076b927",
	"judge": {
		"conditions": [
			{
				"value": "www.baidu.com:8092",
				"operator": "=",
				"type": "HostPort"
			},
			{
				"value": "(^/GateWayService/ReceiveMessage)|(^/GateWayService/RevokeMessage)|(^/GateWayService/GetPatientFromHis)|(^/GateWayService/GetBatchPatientFromHis)|(^/GateWayService/BackFillStatus)|(^/GateWayService/BackFillCritialInfo)|(^/GateWayService/BackFillReportInfo)|(^/GateWayService/ExtensionService)",
				"operator": "match",
				"type": "URI"
			},
			{
				"value": "^/GateWayService/GetCurrentRelations",
				"operator": "not_match",
				"type": "URI"
			}
		],
		"type": 1
	},
	"name": "HIS网关场景集成",
	"handle": {
		"higher_ca": "",
		"log": true,
		"process_txt": "HIS网关场景集成-非法访问"
	},
	"time": "2022-05-26 19:08:45"
}
```





token_auth

一级

```
{
	"host": "10.2.58.24",
	"mode": "D",
	"name": "HIS集成网关接口认证",
	"handle": {
		"continue": true,
		"log": true
	},
	"rules": [
		"bc859649-d02d-47ea-9cd4-4daad076b927"
	],
	"db": 1,
	"port": 6379,
	"time": "2020-12-24 09:47:17",
	"id": "671302ff-811e-4a8c-8dd1-f66c5e35b368",
	"judge": {
		"conditions": [
			{
				"value": "www.baidu.com:8092",
				"operator": "=",
				"type": "HostPort"
			}
		],
		"type": 0
	},
	"enable": false,
	"password": "WFcK8#Tf",
	"type": 1
}
```



二级

```
{
	"extractor": {
		"extractions": [],
		"type": 1
	},
	"enable": false,
	"id": "bc859649-d02d-47ea-9cd4-4daad076b927",
	"judge": {
		"conditions": [
			{
				"value": "www.baidu.com:8092",
				"operator": "=",
				"type": "HostPort"
			},
			{
				"value": "(^/GateWayService/ReceiveMessage)|(^/GateWayService/RevokeMessage)|(^/GateWayService/GetPatientFromHis)|(^/GateWayService/GetBatchPatientFromHis)|(^/GateWayService/BackFillStatus)|(^/GateWayService/BackFillCritialInfo)|(^/GateWayService/BackFillReportInfo)|(^/GateWayService/ExtensionService)",
				"operator": "match",
				"type": "URI"
			},
			{
				"value": "^/GateWayService/GetCurrentRelations",
				"operator": "not_match",
				"type": "URI"
			}
		],
		"type": 1
	},
	"name": "HIS网关场景集成",
	"handle": {
		"higher_ca": "",
		"log": true,
		"process_txt": "HIS网关场景集成-非法访问"
	},
	"time": "2022-05-26 19:08:45"
}
```





session_auth

一级

```
{
	"time": "2020-06-11 11:39:58",
	"enable": false,
	"rules": [
		"1ce856db-07c2-421c-a297-f89cf3fe3d23",
		"9d65a552-8c57-4718-9274-624a8b1c707a",
		"80d23a74-5bcf-4769-85ff-8fb39d64e407"
	],
	"id": "d398859d-e229-4959-b405-191b49015dbc",
	"judge": {
		"conditions": [
			{
				"value": "10.5.67.12:8888",
				"operator": "=",
				"type": "HostPort"
			}
		],
		"type": 0
	},
	"name": "web2d",
	"handle": {
		"continue": true,
		"log": false
	},
	"type": 1
}
```



二级

```
{
	"extractor": {
		"extractions": [],
		"type": 1
	},
	"enable": true,
	"id": "f75769ae-99c2-4516-a28b-9bf040fb2de7",
	"judge": {
		"conditions": [
			{
				"value": "/web2d/\\w{2}-\\w{2}/Venus/Viewer/index",
				"operator": "match",
				"type": "URI"
			}
		],
		"type": 0
	},
	"name": "web2d MG浏览",
	"handle": {
		"token_auth_rule_id": null,
		"log": true,
		"token_auth_id": "",
		"process_txt": "web2d /Venus/Viewer/index 接口非法访问"
	},
	"time": "2020-07-27 17:25:33"
}
```





session_intercept

一级

```
{
	"timeout": 1440,
	"name": "RIS拦截",
	"handle": {
		"continue": true,
		"log": true
	},
	"rules": [
		"0fc57a25-9f8e-4507-b2c7-952945b3fa38",
		"d88b544e-08b2-4f70-a347-496f7d295bbb",
		"761bf521-df24-47c2-864a-ce13ca5a9a56"
	],
	"time": "2020-05-06 17:05:19",
	"enable": false,
	"prefix": "RIS",
	"session_id_name": "ASP.NET_SessionId",
	"id": "8b47bea9-5435-4b57-b0bf-d7aecf0c897a",
	"judge": {
		"conditions": [
			{
				"value": "www.baidu.com:6691",
				"operator": "=",
				"type": "HostPort"
			}
		],
		"type": 0
	},
	"type": 1
}
```



二级

```
{
	"extractor": {
		"extractions": [],
		"type": 1
	},
	"enable": true,
	"id": "0fc57a25-9f8e-4507-b2c7-952945b3fa38",
	"judge": {
		"conditions": [
			{
				"value": "/zh-CN/Home/BeforeLogon",
				"operator": "match",
				"type": "URI"
			}
		],
		"type": 0
	},
	"name": "登录",
	"handle": {
		"intercept_type": 0,
		"log": false,
		"process_txt": "\"success\":true"
	},
	"time": "2020-06-03 13:15:08"
}
```

